<html>

<head>
	<title>KanDroid</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<!-- Google fonts -->
	<!--	<link href="https://fonts.googleapis.com/css?family=Lato:100,300|Open+Sans:300,400" rel="stylesheet">-->
	<!-- Font Awesome -->
	<link rel="stylesheet" href="vendor/fontawesome/css/font-awesome.min.css">
	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="vendor/bootstrap/css/bootstrap.min.css" crossorigin="anonymous">

	<!-- Custom Styles  -->
	<link rel="stylesheet" href="styles.css">
</head>

<body>
	<div class="container chat-container">
		<section class="row chat-header-row">
			<img class="img-responsive chat-logo" src="img/kandroid-logo.png" />
			<h1>KanDroid</h1>
			<h4>Self proclaimed funny Bot</h4>

		</section>


		<section class="row ">
			<div class="chat-messages col-xs-10 col-xs-offset-1">

			</div>
		</section>

		<section class="row chat-input-row">
			<div class="input-group input-group-lg col-xs-10 col-xs-offset-1">
				<!--<span class="input-group-addon">Enter Message</span>-->
				<input type="text" id="input" placeholder="Say Hi" class="form-control"></input>
				<span class="input-group-btn">
        			<button class="btn btn-default" type="button">Send</button>
      			</span>
				<span class="input-group-btn">
					<a class="btn btn-danger chat-mic" id="rec" data-toggle="button" aria-pressed="false" autocomplete="off" href="" style="padding-top: 15px" role="button">
						<i class="fa fa-microphone fa-x"></i>
					</a>
				</span>
			</div>
		</section>
	</div>

	<script src="vendor/jquery/jquery.min.js"></script>
	<script src="vendor/bootstrap/js/bootstrap.min.js" crossorigin="anonymous"></script>
	<script type="text/javascript">
		var accessToken = "0a863377b34143728d5b3323b14e8fc7";
		var baseUrl = "https://api.api.ai/v1/";
		var bSayHiDone = false;

		$(document).ready(function () {
			$("#input").keypress(function (event) {
				if (event.which == 13) {
					event.preventDefault();
					send();
				}
			});
			$("#rec").click(function (event) {
				switchRecognition();
			});

		});

		var recognition;

		function startRecognition() {
			recognition = new webkitSpeechRecognition();
			recognition.onstart = function (event) {

				$msgListItem = "<ul class='list-group col-xs-8  col-xs-offset-4'><li class='list-group-item list-group-item-success'>" + "Listening..." + "</li></ul>";

				$(".chat-messages").append($msgListItem);

				updateRec("start");
			};
			recognition.onresult = function (event) {
				var text = "";
				for (var i = event.resultIndex; i < event.results.length; ++i) {
					text += event.results[i][0].transcript;
				}

				$(".chat-messages ul:last-child").remove();

				setInput(text);
				stopRecognition();
			};
			recognition.onend = function () {
				stopRecognition();
			};
			recognition.lang = "en-US";
			recognition.start();
		}

		function stopRecognition() {
			if (recognition) {
				recognition.stop();
				recognition = null;
			}
			updateRec("stop");
		}

		function switchRecognition() {
			if (recognition) {
				stopRecognition();
			} else {
				startRecognition();
			}
		}

		function setInput(text) {
			$("#input").val(text);
			//Add to chat list on right
			send();
		}

		function updateRec(sEvent) {
			switch (sEvent) {
			case "start":
				{


					break;
				}
			case "stop":
				{

				}
			}
			//$("#rec").toggleClass("active");
			//console.log($("#rec").hasClass("active"));
			//$("#rec").toggleClass("btn-primary, btn-danger").toggleClass("");
			//$("#rec").setClass("btn-danger");
			//if($("#rec").hasClass("btn-primary")){
			//$("#rec").toggleClass("btn-danger", "btn-primary");
			//}
		}

		function send() {
			if (!bSayHiDone) {
				bSayHiDone = true;
				$("#input").attr('placeholder', 'Type a message');
			}
			var text = $("#input").val();
			setUserInput(text); //Adding the text to chat box
			$("#input").val(""); //Clearing Input box

			$.ajax({
				type: "POST",
				url: baseUrl + "query/",
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				headers: {
					"Authorization": "Bearer " + accessToken
				},
				data: JSON.stringify({
					q: text,
					lang: "en"
				}),

				success: function (data) {
					var msg = new SpeechSynthesisUtterance(data.result.speech);
					window.speechSynthesis.speak(msg);

					setResponse(data.result.speech);
				},
				error: function () {
					setResponse("Internal Server Error");
				}
			});
			//setResponse("Loading...");
		}

		function setUserInput(msg) {
			$msgListItem = "<ul class='list-group col-xs-8  col-xs-offset-4'><li class='list-group-item list-group-item-success'>" + msg + "</li></ul>";
			$(".chat-messages").append($msgListItem);
		};

		function setResponse(msg) {
			//$("#response").text(val);
			$msgListItem = "<ul class='list-group col-xs-8'><li class='list-group-item'>" + msg + "</li></ul>";
			$(".chat-messages").append($msgListItem);

		}
	</script>

</body>

</html>